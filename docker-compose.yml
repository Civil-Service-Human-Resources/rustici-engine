version: '3.9'
services:

  rustici-engine:
    links:
      - azurite:localhost/azurite
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - ./env/rusticiLocalEnv
    depends_on:
      - mysql
      - azurite
      - csl-service
    ports:
      - 3000:8080
  
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    command: "azurite --loose --blobHost 0.0.0.0 --blobPort 9100 --queueHost 0.0.0.0 --location /workspace --debug /workspace/debug.log"
    ports:
      - 9100:9100
    volumes:
      - azurite:/workspace

  mysql:
    # container_name: mysql
    image: mysql:8.0
    volumes:
      - dbdata:/var/lib/mysql
      - ./mysql:/tmp/database
    ports:
      - 3306:3306
    command: mysqld --init-file="/tmp/database/setup.sql"
    environment: 
      - MYSQL_ROOT_PASSWORD=my-secret-pw

  # replace this with the actual csl-service when it's ready. For now,
  # use a dummy endpoint to ensure that rollup data is being sent correctly.
  csl-service:
    build:
      context: ./csl-service
      dockerfile: Dockerfile
    ports:
      - 9003:9003
    volumes:
      - ./csl-service/app.py:/app/app.py

  # nginx:
  #   container_name: nginx
  #   image: nginx:stable-alpine
  #   restart: always
  #   ports:
  #     - 80:80
  #   depends_on: 
  #     - rustici-engine
  #     - azurite
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
  #     - ./nginx/access.log:/var/log/nginx/access.log

volumes:
  dbdata:
  azurite: